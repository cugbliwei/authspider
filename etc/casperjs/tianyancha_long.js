var up = [
    {"username": "17310653630", "password": "weili105"},
    {"username": "17183246634", "password": "17183246634uio"},
    {"username": "17181264695", "password": "17181264695uio"},
    {"username": "17183246845", "password": "17183246845uio"},
    {"username": "17183246841", "password": "17183246841uio"},
    {"username": "17183146824", "password": "17183146824uio"},
    {"username": "17183014690", "password": "17183014690uio"},
    {"username": "17183143094", "password": "17183143094uio"},
    {"username": "17187032945", "password": "17187032945uio"},
    {"username": "17186114095", "password": "17186114095uio"},
    {"username": "17183141248", "password": "17183141248uio"},
    {"username": "17183141243", "password": "17183141243uio"},
    {"username": "17188202634", "password": "17188202634uio"},
    {"username": "17187629463", "password": "17187629463uio"},
    {"username": "17187629469", "password": "17187629469uio"},
    {"username": "17187611437", "password": "17187611437uio"},
    {"username": "17188581834", "password": "17188581834uio"},
    {"username": "17181404315", "password": "17181404315uio"},
    {"username": "17181404439", "password": "17181404439uio"},
    {"username": "17181404436", "password": "17181404436uio"},
    {"username": "17181404425", "password": "17181404425uio"},
    {"username": "17181404415", "password": "17181404415uio"},
    {"username": "17181404407", "password": "17181404407uio"},
    {"username": "17181404406", "password": "17181404406uio"},
    {"username": "17187794436", "password": "17187794436uio"},
    {"username": "17187794204", "password": "17187794204uio"},
    {"username": "17183246745", "password": "17183246745uio"},
    {"username": "17183246804", "password": "17183246804uio"},
    {"username": "17183246824", "password": "17183246824uio"},
    {"username": "17183246834", "password": "17183246834uio"},
    {"username": "17187790254", "password": "17187790254uio"},
    {"username": "17187790415", "password": "17187790415uio"},
    {"username": "17187794438", "password": "17187794438uio"},
    {"username": "17187792364", "password": "17187792364uio"},
    {"username": "17187793640", "password": "17187793640uio"},
    {"username": "17187793641", "password": "17187793641uio"},
    {"username": "17187793642", "password": "17187793642uio"},
    {"username": "17187794465", "password": "17187794465uio"},
    {"username": "17187794463", "password": "17187794463uio"},
    {"username": "17185964824", "password": "17185964824uio"},
    {"username": "17185965241", "password": "17185965241uio"},
    {"username": "17187794174", "password": "17187794174uio"},
    {"username": "17187612475", "password": "17187612475uio"},
    {"username": "17187621714", "password": "17187621714uio"},
    {"username": "17187624878", "password": "17187624878uio"},
    {"username": "17187628437", "password": "17187628437uio"},
    {"username": "17183246646", "password": "17183246646uio"},
    {"username": "17183141435", "password": "17183141435uio"},
    {"username": "17183141434", "password": "17183141434uio"},
    {"username": "17182407634", "password": "17182407634uio"},
    {"username": "17182417340", "password": "17182417340uio"},
    {"username": "17188587540", "password": "17188587540uio"},
    {"username": "17188587480", "password": "17188587480uio"},
    {"username": "17188587541", "password": "17188587541uio"},
    {"username": "17188587641", "password": "17188587641uio"},
    {"username": "17188587614", "password": "17188587614uio"},
    {"username": "17188587674", "password": "17188587674uio"},
    {"username": "17188581854", "password": "17188581854uio"},
    {"username": "17188587742", "password": "17188587742uio"},
    {"username": "17188587493", "password": "17188587493uio"},
    {"username": "17188587491", "password": "17188587491uio"},
    {"username": "17188587490", "password": "17188587490uio"},
    {"username": "17188587489", "password": "17188587489uio"},
    {"username": "17188587487", "password": "17188587487uio"},
    {"username": "17188587486", "password": "17188587486uio"},
    {"username": "17188587485", "password": "17188587485uio"},
    {"username": "17188587484", "password": "17188587484uio"},
    {"username": "17188587482", "password": "17188587482uio"},
    {"username": "17188587481", "password": "17188587481uio"},
    {"username": "17188587479", "password": "17188587479uio"},
    {"username": "17188587478", "password": "17188587478uio"},
    {"username": "17188587476", "password": "17188587476uio"},
    {"username": "17188587494", "password": "17188587494uio"},
    {"username": "17188587492", "password": "17188587492uio"},
    {"username": "17187297154", "password": "17187297154uio"},
    {"username": "17187794964", "password": "17187794964uio"},
    {"username": "17187794954", "password": "17187794954uio"},
    {"username": "17187794948", "password": "17187794948uio"},
    {"username": "17187794947", "password": "17187794947uio"},
    {"username": "17187794946", "password": "17187794946uio"},
    {"username": "17187794945", "password": "17187794945uio"},
    {"username": "17187794943", "password": "17187794943uio"},
    {"username": "17187794941", "password": "17187794941uio"},
    {"username": "17187794942", "password": "17187794942uio"},
    {"username": "17187794940", "password": "17187794940uio"},
    {"username": "17187794924", "password": "17187794924uio"},
    {"username": "17187794914", "password": "17187794914uio"},
    {"username": "17188587454", "password": "17188587454uio"},
    {"username": "17188587451", "password": "17188587451uio"},
    {"username": "17188587452", "password": "17188587452uio"},
    {"username": "17187794467", "password": "17187794467uio"},
    {"username": "17187037342", "password": "17187037342uio"},
    {"username": "17187794425", "password": "17187794425uio"},
    {"username": "17187794246", "password": "17187794246uio"},
    {"username": "17187611401", "password": "17187611401uio"},
    {"username": "17187695154", "password": "17187695154uio"},
    {"username": "17182575451", "password": "17182575451uio"},
    {"username": "17183244853", "password": "17183244853uio"},
    {"username": "17181403402", "password": "17181403402uio"},
    {"username": "17181403014", "password": "17181403014uio"},
    {"username": "17187694454", "password": "17187694454uio"}
];

var system = require('system');
var fs = require('fs');
var casper = require('casper').create({
    javascriptEnabled: true,
    XSSAuditingEnabled: true,
    waitTimeout: 120000,
    timeout: 120000,
    //logLevel: "debug",
    //verbose: true,
    pageSettings: {
        loadPlugins: false,
        loadImages: true,
        userAgent: 'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_10_5) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/42.0.2311.152 Safari/537.36'
    }
});
var mouse = require("mouse").create(casper);
var file_path = '';
var key = '';

casper.start('http://www.tianyancha.com/login').wait(100, function() {
    loopBody.call(this, 1, 1, '.modulebtn2');
});

casper.wait(100, function() {
    this.click('.modulebtn2');
    this.wait(500, function() {
        var r = Math.floor(Math.random() * 101);
        //console.log(r, up[r]["username"], up[r]["password"]);
        this.sendKeys('.mobile_box .contactphone', up[r]["username"], {reset: true});
        this.sendKeys('.mobile_box .contactword', up[r]["password"], {reset: true});
        this.click('.mobile_box .login_btn');
    });
});

casper.wait(100, function() {
    loopBody.call(this, 1, 1, '.search_button');
});

casper.wait(100, function() {
    this.click('#live-search');
    //this.capture('submit.png');
});

casper.wait(50, function() {
    system.stdout.write('need_path\n');
    file_path = system.stdin.readLine().trim() + '/';
    system.stdout.write('need_key\n');
    key = system.stdin.readLine().trim();
});

casper.wait(50, function() {
    this.sendKeys('#live-search', key, {reset: true});
    this.wait(100, function() {
        this.click('.search_button');
    });
});

casper.wait(100, function() {
    loopBody.call(this, 1, 1, '.search-multi-filter');
});

casper.wait(100, function() {
    fs.write(file_path + 'submit.html', this.getHTML(), 'w');
    //this.capture(file_path + 'submit.png');
    if(!this.exists('.query_name span')) {
        system.stdout.write('finish###没有找到相关结果\n');
        this.exit();
    }
    
    var names = this.getElementsInfo('.query_name span');
    var i = 0;
    for(var j = 0; j < names.length; j++) {
        if(key == names[j].text.trim()) {
            i = j;
            break;
        }
    }
    var urls = this.getElementsAttribute('.query_name', 'href');
    this.wait(50, function() {
        if (urls.length > 0) {
            system.stdout.write('set_params###' + urls[i] + '\n');
            this.open(urls[i]).wait(100, function() {
                this.wait(50, function() {
                    loopBody.call(this, 1, 1, '.company_header_width');
                });
                this.wait(50, function() {
                    var companyId = this.getElementAttribute('#_companyId', 'value');
                    var change_type = this.getElementsAttribute('.company_pager .pagination', 'change-type');
                    var page_count = this.getElementsAttribute('.company_pager .pagination', 'page-total');
                    var page_total = this.getElementsInfo('.company_pager .total');
                    console.log(companyId, change_type, page_count, page_total);
                    if (page_total.length > 0) {
                        for(var j = 0; j < page_total.length; j++) {
                            var key = page_total[j].text.trim();
                            var re = /共\s*([0-9]*)\s*页/;
                            var rk = re.exec(key);
                            console.log(rk);
                        }
                    }
                });
                this.wait(50, function() {
                    this.exit();
                });
            });
            this.wait(1000, function() {
                html = this.getHTML();
                html = html.replace(new RegExp('\n', 'gm'), '');
                system.stdout.write('html&&&index###' + html + '\n');
                fs.write(file_path + 'url.html', this.getHTML(), 'w');
                //this.capture(file_path + 'url.png');
                this.mouse.move('.user_title .fa-caret-down');
                this.evaluate(function() {
                    document.querySelector('#userShow .list-group-item:nth-child(4)').click();
                });
                this.wait(100, function() {
                    loopBody.call(this, 1, 1, '.search_button');
                });
            });
            this.wait(50, function() {
                system.stdout.write('finish###抓取完成\n');
            });
        }
    });
});

function loopBody(flag, times, target) {
    if (flag == 0) {
        return;
    }
    else if (times > 120) {
        fs.write(file_path + 'wrong.html', this.getHTML(), 'w');
        this.capture(file_path + 'wrong.png');
        system.stdout.write('finish###没有找到相关结果\n');
        return
    }
    this.then(function(){
        this.wait(500, function() {
            var tar = this.fetchText(target).trim();
            if(tar.length > 0) {
                flag = 0;
            }
        });
    });
    this.then(function(){
        times++;
        loopBody.call(this, flag, times, target);
    });
}

casper.run();
